#!/bin/bash

# Exit immediately if a command exits with a non-zero status
set -e

# Function to check for root privileges
check_root() {
    if [[ "$EUID" -ne 0 ]]; then
        echo "Please run as root or with sudo."
        exit 1
    fi
}

# Function to install a package manager if not installed
install_package_manager() {
    local manager="$1"
    local install_command="$2"

    if ! command -v "$manager" &> /dev/null; then
        echo "$manager is not installed. Installing..."
        if ! eval "$install_command"; then
            echo "Failed to install $manager. Please install it manually and try again."
            exit 1
        fi
    else
        echo "$manager is already installed."
    fi
}

# Function to update the package database for each manager
update_database() {
    if command -v pacman &> /dev/null; then
        pacman -Sy --noconfirm
    fi

    if command -v yay &> /dev/null; then
        yay -Sy --noconfirm
    fi

    if command -v apt-get &> /dev/null; then
        apt-get update -y
    fi

    if command -v dnf &> /dev/null; then
        dnf check-update -y
    fi

    if command -v zypper &> /dev/null; then
        zypper refresh
    fi

    if command -v brew &> /dev/null; then
        brew update
    fi

    if command -v snap &> /dev/null; then
        snap refresh
    fi

    if command -v flatpak &> /dev/null; then
        flatpak update
    fi

    echo "Package databases updated."
}

# Function to install a package using available package managers
install_package() {
    local package="$1"

    echo "Installing $package..."

    if command -v pacman &> /dev/null; then
        pacman -S --noconfirm "$package" && return
    fi

    if command -v yay &> /dev/null; then
        yay -S --noconfirm "$package" && return
    fi

    if command -v apt-get &> /dev/null; then
        apt-get install -y "$package" && return
    fi

    if command -v dnf &> /dev/null; then
        dnf install -y "$package" && return
    fi

    if command -v zypper &> /dev/null; then
        zypper install -y "$package" && return
    fi

    if command -v brew &> /dev/null; then
        brew install "$package" && return
    fi

    if command -v snap &> /dev/null; then
        snap install "$package" && return
    fi

    if command -v flatpak &> /dev/null; then
        flatpak install -y "$package" && return
    fi

    echo "Failed to install $package with any package manager."
}

# Function to update all packages
update_packages() {
    echo "Updating packages..."

    if command -v pacman &> /dev/null; then
        pacman -Syu --noconfirm
    fi

    if command -v yay &> /dev/null; then
        yay -Syu --noconfirm
    fi

    if command -v apt-get &> /dev/null; then
        apt-get upgrade -y
    fi

    if command -v dnf &> /dev/null; then
        dnf upgrade -y
    fi

    if command -v zypper &> /dev/null; then
        zypper update
    fi

    if command -v brew &> /dev/null; then
        brew upgrade
    fi

    if command -v snap &> /dev/null; then
        snap refresh
    fi

    if command -v flatpak &> /dev/null; then
        flatpak update
    fi

    echo "All packages updated."
}

# Main script logic
check_root

# Install package managers if not installed
install_package_manager "yay" "pacman -S --noconfirm yay"
install_package_manager "dnf" "apt-get install -y dnf"
install_package_manager "zypper" "apt-get install -y zypper"
install_package_manager "brew" "apt-get install -y linuxbrew-wrapper"
install_package_manager "snap" "apt-get install -y snapd"
install_package_manager "flatpak" "apt-get install -y flatpak"

# Update package databases
update_database

case "$1" in
    install)
        shift
        for package in "$@"; do
            install_package "$package"
        done
        ;;
    update)
        update_packages
        ;;
    *)
        echo "Usage: $0 {install|update} [package_name...]"
        exit 1
        ;;
esac
